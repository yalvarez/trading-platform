services:
  redis:
    image: redis:7-alpine
    container_name: atp-redis
    ports:
      - "6379:6379"
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 10

  # =========================
  # MT5 ACCOUNTS (6)
  # Each one exposes:
  # - Web VNC: 3000
  # - RPyC MT5 bridge: 8001
  # =========================
  mt5_acct1:
    image: gmag11/metatrader5_vnc:latest
    container_name: atp-mt5-acct1
    environment:
      - CUSTOM_USER=yalvarezc
      - PASSWORD=mt5VNCP@ss19375
    ports:
      - "3001:3000"
      - "8001:8001"
    volumes:
      - mt5_acct1_config:/config
    healthcheck:
      test: ["CMD", "nc", "-z", "127.0.0.1", "8001"]
      interval: 5s
      timeout: 2s
      retries: 10

  mt5_acct2:
    image: gmag11/metatrader5_vnc:latest
    container_name: atp-mt5-acct2
    environment:
      - CUSTOM_USER=${MT5_WEB_USER}
      - PASSWORD=${MT5_WEB_PASS}
    ports:
      - "3002:3000"
      - "8002:8001"
    volumes:
      - mt5_acct2_config:/config

  # mt5_acct3:
  #   image: gmag11/metatrader5_vnc:latest
  #   container_name: atp-mt5-acct3
  #   environment:
  #     - CUSTOM_USER=${MT5_WEB_USER}
  #     - PASSWORD=${MT5_WEB_PASS}
  #   ports:
  #     - "3003:3000"
  #     - "8003:8001"
  #   volumes:
  #     - mt5_acct3_config:/config

  # mt5_acct4:
  #   image: gmag11/metatrader5_vnc:latest
  #   container_name: atp-mt5-acct4
  #   environment:
  #     - CUSTOM_USER=${MT5_WEB_USER}
  #     - PASSWORD=${MT5_WEB_PASS}
  #   ports:
  #     - "3004:3000"
  #     - "8004:8001"
  #   volumes:
  #     - mt5_acct4_config:/config

  # mt5_acct5:
  #   image: gmag11/metatrader5_vnc:latest
  #   container_name: atp-mt5-acct5
  #   environment:
  #     - CUSTOM_USER=${MT5_WEB_USER}
  #     - PASSWORD=${MT5_WEB_PASS}
  #   ports:
  #     - "3005:3000"
  #     - "8005:8001"
  #   volumes:
  #     - mt5_acct5_config:/config

  # mt5_acct6:
  #   image: gmag11/metatrader5_vnc:latest
  #   container_name: atp-mt5-acct6
  #   environment:
  #     - CUSTOM_USER=${MT5_WEB_USER}
  #     - PASSWORD=${MT5_WEB_PASS}
  #   ports:
  #     - "3006:3000"
  #     - "8006:8001"
  #   volumes:
  #     - mt5_acct6_config:/config

  telegram_ingestor:
    build:
      context: .
      dockerfile: services/telegram_ingestor/Dockerfile
    container_name: atp-telegram-ingestor
    env_file:
      - .env
    depends_on:
      - redis
    restart: unless-stopped
    volumes:
      - ./services/telegram_ingestor/telegram_ingestor.session:/app/services/telegram_ingestor/telegram_ingestor.session:rw

  router_parser:
    build:
      context: .
      dockerfile: services/router_parser/Dockerfile
    container_name: atp-router-parser
    env_file:
      - .env
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped

  market_data:
    build:
      context: .
      dockerfile: services/market_data/Dockerfile
    container_name: atp-market-data
    env_file:
      - .env
    depends_on:
      - redis
      - mt5_acct1
    restart: unless-stopped

  trade_orchestrator:
    build:
      context: .
      dockerfile: services/trade_orchestrator/Dockerfile
    container_name: atp-trade-orchestrator
    env_file:
      - .env
    depends_on:
      - redis
      - mt5_acct1
      - mt5_acct2
    restart: unless-stopped
    volumes:
      - ./services/telegram_ingestor/telegram_ingestor.session:/app/services/telegram_ingestor/telegram_ingestor.session:rw
    healthcheck:
      test: ["CMD", "sh", "-c", "test -f /tmp/telegram_notifier.ready"]
      interval: 10s
      timeout: 5s
      retries: 6
    ports:
      - "8000:8000"

volumes:
  redis_data:
  mt5_acct1_config:
  mt5_acct2_config:
  # mt5_acct3_config:
  # mt5_acct4_config:
  # mt5_acct5_config:
  # mt5_acct6_config:
